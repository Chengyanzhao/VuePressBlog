# 事件循环与消息队列

想要了解事件循环、消息队列，我们先要解决以下几个疑惑：

## 既然是单线程，为什么还有异步的说法？

JavaScript是一门单线程的语言，为什么还会有异步的概念，工作中会经常遇到异步代码？  

关于单线程，是指js引擎中负责解释和执行JavaScript代码的线程只有一个，也可称为主线程。事实上还有其他线程存在，如处理ajax请求的线程，处理dom事件的线程，定时器线程等，这些线程大部分由宿主(浏览器Web API,NodeJS等)提供。这里我们不具体讲他们的分类，暂且把它们都称为工作线程。这些这些工作线程可以和主线程同时执行任务，所以也就出现了“异步”的概念。  
比如我们发起了一个ajax请求，去服务端请求的操作交给工作线程来处理，主线程继续执行后面的任务，这就是一个异步任务。

## 为什么要设计出异步任务？

如果我们的ajax请求是同步的，那么ajax请求后面的代码就需要等待ajax返回结果后才能执行，这种耗时较长的任务阻塞了后面代码的执行，浪费了cup的算力。从用户角度来讲，这种阻塞的情况会导致页面卡主，用户只能干瞪眼儿等着，体验极差。想想如果是你，会不会掏出搬砖给开发者展示一下十八般武艺？

异步任务就很好的解决了这个问题，当我们发起ajax请求后，异步任务交给工作线程去做，主线程继续执行后面的任务，等异步任务完成后再去执行异步的回调。这样既不浪费系统资源，也不会造成卡顿页面，所以我们需要异步任务来让用户放下手中的板砖。

## 事件循环/消息队列

要理解事件循环和消息队列，我们需要了解两个概念：

1. 函数栈：主线性执行代码的栈。
2. 消息队列(queue)：由js运行时提供的一个存放待处理消息的队列，每个消息都关联着一个用以处理这个消息的函数（比如异步任务发起时传入的回调函数）。

3. 事件循环(Event Loop)：是指主线程清空函数栈后，js引擎从消息队列中取出一个消息，并作为输入参数调用与之关联的用于处理消息的函数，将这个函数推入函数栈，主线程来执行它。当函数栈清空后，重复前面的操作，继续处理下一个消息。js引擎从消息队列中循环获取消息的过程就是事件循环。

## 检查-你是否真的理解了本章内容？

下方函数的打印结果是什么：

``` js
console.log(1)
setTimeout(()=>{
  console.log(2)
},500)
console.log(3)
setTimeout(()=>{
  console.log(4)
},0)
console.log(5)
```

正确的输出是：`1 3 5 4 2`。

如果你答对了，那么恭喜你，对于这部分的内容你已经掌握了。如果答错了，回过头再看看前面讲过的运行机制。

## 巧用事件循环

假设有一个很长的列表需要遍历，每个item生成一个dom挂载到页面上，这样的同步任务会阻塞线程，用户无法触发页面上的事件。此时我们可以利用异步的特点来解决这个问题。

我们可以将列表拆分成n个小列表，然后依次将n个小列表利用setTimeout生成n个异步任务并执行，主线程循环读取消息队列中的消息。

## 总结

1. js引擎始终只有一个线程，执行函数栈。
一个 JavaScript 运行时包含了一个待处理的消息队列。每一个消息都关联着一个用以处理这个消息的函数。
refs:

[并发模型与事件循环
](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop)